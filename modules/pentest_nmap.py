#!/usr/bin/env python3
"""
Module d'automatisation de pentest avec Nmap
Pour API Flask
"""

import os
import json
from datetime import datetime

try:
    import nmap
except ImportError:
    raise ImportError("python-nmap non installé. Installez avec: pip install python-nmap")


class PentestNmap:
    def __init__(self, target):
        self.target = target
        self.nm = nmap.PortScanner()
        self.results = {
            'target': target,
            'scan_date': datetime.now().isoformat(),
            'nmap_version': self.nm.nmap_version(),
            'scans': {}
        }
    
    def check_nmap_installed(self):
        """Vérifie que Nmap est installé"""
        try:
            version = self.nm.nmap_version()
            return True
        except:
            return False
    
    def quick_scan(self):
        """Scan rapide des ports les plus courants"""
        try:
            self.nm.scan(self.target, arguments='-F -T4')
            self.results['scans']['quick'] = self._parse_results()
            return True
        except Exception as e:
            self.results['scans']['quick'] = {'error': str(e)}
            return False
    
    def full_scan(self, ports='1-1000'):
        """Scan complet avec détection de services"""
        try:
            self.nm.scan(self.target, ports, arguments='-sV -sC -T4')
            self.results['scans']['full'] = self._parse_results()
            return True
        except Exception as e:
            self.results['scans']['full'] = {'error': str(e)}
            return False
    
    def vuln_scan(self):
        """Scan de vulnérabilités avec scripts NSE"""
        try:
            self.nm.scan(self.target, arguments='--script vuln -T4')
            self.results['scans']['vulnerabilities'] = self._parse_results()
            return True
        except Exception as e:
            self.results['scans']['vulnerabilities'] = {'error': str(e)}
            return False
    
    def os_detection(self):
        """Détection du système d'exploitation"""
        try:
            self.nm.scan(self.target, arguments='-O')
            self.results['scans']['os_detection'] = self._parse_results()
            return True
        except Exception as e:
            self.results['scans']['os_detection'] = {
                'error': str(e),
                'note': 'Nécessite les droits root/sudo'
            }
            return False
    
    def _parse_results(self):
        """Parse les résultats pour export JSON"""
        parsed = {}
        for host in self.nm.all_hosts():
            parsed[host] = {
                'hostname': self.nm[host].hostname(),
                'state': self.nm[host].state(),
                'protocols': {}
            }
            
            for proto in self.nm[host].all_protocols():
                parsed[host]['protocols'][proto] = {}
                ports = self.nm[host][proto].keys()
                
                for port in ports:
                    port_info = self.nm[host][proto][port]
                    parsed[host]['protocols'][proto][str(port)] = {
                        'state': port_info.get('state'),
                        'name': port_info.get('name'),
                        'product': port_info.get('product', ''),
                        'version': port_info.get('version', ''),
                        'extrainfo': port_info.get('extrainfo', ''),
                        'scripts': port_info.get('script', {})
                    }
            
            # OS detection
            if 'osmatch' in self.nm[host]:
                parsed[host]['os_matches'] = []
                for osmatch in self.nm[host]['osmatch'][:3]:
                    parsed[host]['os_matches'].append({
                        'name': osmatch['name'],
                        'accuracy': osmatch['accuracy']
                    })
        
        return parsed
    
    def generate_report(self, output_dir='reports'):
        """Génère un rapport JSON"""
        os.makedirs(output_dir, exist_ok=True)
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"{output_dir}/nmap_report_{self.target}_{timestamp}.json"
        
        with open(filename, 'w') as f:
            json.dump(self.results, f, indent=2)
        
        return filename
