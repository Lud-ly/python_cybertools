#!/usr/bin/env python3
"""
Script d'automatisation de pentest avec Nmap
Nécessite: nmap installé sur le système

"""

import argparse
import sys
import os
import json
from datetime import datetime

try:
    import nmap
except ImportError:
    print("[!] Erreur: python-nmap non installé")
    print("[!] Installation: pip install python-nmap")
    sys.exit(1)


class PentestNmap:
    def __init__(self, target):
        self.target = target
        self.nm = nmap.PortScanner()
        self.results = {
            'target': target,
            'scan_date': datetime.now().isoformat(),
            'nmap_version': self.nm.nmap_version(),
            'scans': {}
        }
    
    def check_nmap_installed(self):
        """Vérifie que Nmap est installé"""
        try:
            version = self.nm.nmap_version()
            print(f"[+] Nmap version {version[0]}.{version[1]} détectée\n")
            return True
        except:
            print("[!] Erreur: Nmap n'est pas installé sur le système")
            print("[!] Installation:")
            print("    - macOS: brew install nmap")
            print("    - Linux: sudo apt-get install nmap")
            print("    - Windows: https://nmap.org/download.html")
            return False
    
    def quick_scan(self):
        """Scan rapide des ports les plus courants"""
        print("[PHASE 1] Scan rapide (top 100 ports)")
        print("-" * 60)
        
        try:
            # -F = Fast scan (top 100 ports)
            # -T4 = Timing aggressive
            self.nm.scan(self.target, arguments='-F -T4')
            self._display_results('quick_scan')
            self.results['scans']['quick'] = self._parse_results()
        except Exception as e:
            print(f"[!] Erreur lors du scan: {e}")
    
    def full_scan(self, ports='1-1000'):
        """Scan complet avec détection de services"""
        print(f"\n[PHASE 2] Scan complet ports {ports}")
        print("-" * 60)
        
        try:
            # -sV = Version detection
            # -sC = Script scan (default scripts)
            # -T4 = Timing aggressive
            self.nm.scan(self.target, ports, arguments='-sV -sC -T4')
            self._display_results('full_scan')
            self.results['scans']['full'] = self._parse_results()
        except Exception as e:
            print(f"[!] Erreur lors du scan: {e}")
    
    def vuln_scan(self):
        """Scan de vulnérabilités avec scripts NSE"""
        print("\n[PHASE 3] Scan de vulnérabilités")
        print("-" * 60)
        
        try:
            # --script vuln = Scripts de détection de vulns
            self.nm.scan(self.target, arguments='--script vuln -T4')
            self._display_results('vuln_scan')
            self.results['scans']['vulnerabilities'] = self._parse_results()
        except Exception as e:
            print(f"[!] Erreur lors du scan: {e}")
    
    def os_detection(self):
        """Détection du système d'exploitation"""
        print("\n[PHASE 4] Détection de l'OS")
        print("-" * 60)
        
        try:
            # -O = OS detection (nécessite root/sudo)
            print("[!] Nécessite les droits root (sudo)")
            self.nm.scan(self.target, arguments='-O')
            self._display_os_results()
            self.results['scans']['os_detection'] = self._parse_results()
        except Exception as e:
            print(f"[!] Erreur: {e}")
            print("[!] Relancez avec sudo pour l'OS detection")
    
    def _display_results(self, scan_type):
        """Affiche les résultats du scan"""
        for host in self.nm.all_hosts():
            print(f"\n[+] Host: {host} ({self.nm[host].hostname()})")
            print(f"[+] State: {self.nm[host].state()}")
            
            for proto in self.nm[host].all_protocols():
                print(f"\n[+] Protocol: {proto}")
                
                ports = self.nm[host][proto].keys()
                for port in sorted(ports):
                    port_info = self.nm[host][proto][port]
                    state = port_info['state']
                    service = port_info.get('name', 'unknown')
                    product = port_info.get('product', '')
                    version = port_info.get('version', '')
                    
                    print(f"    Port {port:5} {state:8} {service:15} {product} {version}")
                    
                    # Scripts NSE
                    if 'script' in port_info:
                        for script_name, output in port_info['script'].items():
                            print(f"        [NSE] {script_name}:")
                            for line in output.split('\n')[:5]:  # 5 premières lignes
                                if line.strip():
                                    print(f"              {line}")
    
    def _display_os_results(self):
        """Affiche les résultats de l'OS detection"""
        for host in self.nm.all_hosts():
            if 'osmatch' in self.nm[host]:
                print(f"\n[+] OS détecté pour {host}:")
                for osmatch in self.nm[host]['osmatch'][:3]:  # Top 3
                    accuracy = osmatch['accuracy']
                    name = osmatch['name']
                    print(f"    {name} (Précision: {accuracy}%)")
    
    def _parse_results(self):
        """Parse les résultats pour export JSON"""
        parsed = {}
        for host in self.nm.all_hosts():
            parsed[host] = {
                'hostname': self.nm[host].hostname(),
                'state': self.nm[host].state(),
                'protocols': {}
            }
            
            for proto in self.nm[host].all_protocols():
                parsed[host]['protocols'][proto] = {}
                ports = self.nm[host][proto].keys()
                
                for port in ports:
                    parsed[host]['protocols'][proto][str(port)] = self.nm[host][proto][port]
        
        return parsed
    
    def generate_report(self, output_dir='reports'):
        """Génère un rapport JSON"""
        os.makedirs(output_dir, exist_ok=True)
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"{output_dir}/nmap_report_{self.target}_{timestamp}.json"
        
        with open(filename, 'w') as f:
            json.dump(self.results, f, indent=2)
        
        print(f"\n[✓] Rapport sauvegardé: {filename}")
        return filename


def main():
    banner = """
    ╔═══════════════════════════════════════════╗
    ║   PENTEST AUTOMATION - NMAP EDITION      ║
    ║   Author: Ludovic Mouly                  ║
    ╚═══════════════════════════════════════════╝
    """
    print(banner)
    
    parser = argparse.ArgumentParser(
        description='Script de pentest automatisé avec Nmap',
        epilog='Exemple: python pentest_auto.py --target example.com --full'
    )
    
    parser.add_argument('--target', '-t', required=True, help='Cible (IP ou domaine)')
    parser.add_argument('--quick', action='store_true', help='Scan rapide (top 100 ports)')
    parser.add_argument('--full', action='store_true', help='Scan complet avec service detection')
    parser.add_argument('--vuln', action='store_true', help='Scan de vulnérabilités')
    parser.add_argument('--os', action='store_true', help='Détection OS (nécessite sudo)')
    parser.add_argument('--ports', '-p', default='1-1000', help='Range de ports (défaut: 1-1000)')
    parser.add_argument('--output', '-o', default='reports', help='Dossier de sortie')
    parser.add_argument('--all', action='store_true', help='Tous les scans (sauf OS)')
    
    args = parser.parse_args()
    
    # Initialisation
    pentest = PentestNmap(args.target)
    
    if not pentest.check_nmap_installed():
        sys.exit(1)
    
    print("="*60)
    print(f"[*] Target: {args.target}")
    print(f"[*] Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("="*60 + "\n")
    
    # Exécution des scans
    if args.all:
        pentest.quick_scan()
        pentest.full_scan(args.ports)
        pentest.vuln_scan()
    else:
        if args.quick:
            pentest.quick_scan()
        
        if args.full:
            pentest.full_scan(args.ports)
        
        if args.vuln:
            pentest.vuln_scan()
        
        if args.os:
            pentest.os_detection()
    
    # Génération du rapport
    pentest.generate_report(args.output)
    
    print("\n" + "="*60)
    print("[✓] Scan terminé!")
    print("="*60)


if __name__ == '__main__':
    main()
